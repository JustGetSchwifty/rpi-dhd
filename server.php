<?php

   /*$todo = [
      "Argos" => "Stargate SG·1 symbol 24.svgStargate SG·1 symbol 04.svgStargate SG·1 symbol 20.svgStargate SG·1 symbol 09.svgStargate SG·1 symbol 15.svgStargate SG·1 symbol 29.svg",
      "Bedrosia" => "Stargate SG·1 symbol 20.svgStargate SG·1 symbol 04.svgStargate SG·1 symbol 23.svgStargate SG·1 symbol 29.svgStargate SG·1 symbol 25.svgStargate SG·1 symbol 37.svg",
      "Camelot" => "Stargate SG·1 symbol 20.svgStargate SG·1 symbol 02.svgStargate SG·1 symbol 35.svgStargate SG·1 symbol 08.svgStargate SG·1 symbol 26.svgStargate SG·1 symbol 15.svg",
      "Cartago" => "Stargate SG·1 symbol 29.svgStargate SG·1 symbol 08.svgStargate SG·1 symbol 18.svgStargate SG·1 symbol 22.svgStargate SG·1 symbol 04.svgStargate SG·1 symbol 25.svg",
      "Castania" => "Stargate SG·1 symbol 29.svgStargate SG·1 symbol 03.svgStargate SG·1 symbol 06.svgStargate SG·1 symbol 09.svgStargate SG·1 symbol 10.svgStargate SG·1 symbol 16.svg",
      "Chulak" => "Stargate SG·1 symbol 09.svgStargate SG·1 symbol 02.svgStargate SG·1 symbol 23.svgStargate SG·1 symbol 15.svgStargate SG·1 symbol 37.svgStargate SG·1 symbol 20.svg",
      "Cimmeria" => "Stargate SG·1 symbol 11.svgStargate SG·1 symbol 35.svgStargate SG·1 symbol 22.svgStargate SG·1 symbol 17.svgStargate SG·1 symbol 06.svgStargate SG·1 symbol 26.svg",
      "Edora" => "Stargate SG·1 symbol 28.svgStargate SG·1 symbol 24.svgStargate SG·1 symbol 35.svgStargate SG·1 symbol 09.svgStargate SG·1 symbol 15.svgStargate SG·1 symbol 03.svg",
      "Euronda" => "Stargate SG·1 symbol 30.svgStargate SG·1 symbol 27.svgStargate SG·1 symbol 09.svgStargate SG·1 symbol 07.svgStargate SG·1 symbol 18.svgStargate SG·1 symbol 16.svg",
      "Hanka" => "Stargate SG·1 symbol 30.svgStargate SG·1 symbol 06.svgStargate SG·1 symbol 24.svgStargate SG·1 symbol 12.svgStargate SG·1 symbol 14.svgStargate SG·1 symbol 19.svg",
      "Heliopolis" => "Stargate SG·1 symbol 27.svgStargate SG·1 symbol 07.svgStargate SG·1 symbol 15.svgStargate SG·1 symbol 32.svgStargate SG·1 symbol 13.svgStargate SG·1 symbol 30.svg",
      "Juna" => "Stargate SG·1 symbol 29.svgStargate SG·1 symbol 08.svgStargate SG·1 symbol 18.svgStargate SG·1 symbol 22.svgStargate SG·1 symbol 04.svgStargate SG·1 symbol 25.svg",
      "KTau" => "Stargate SG·1 symbol 18.svgStargate SG·1 symbol 02.svgStargate SG·1 symbol 30.svgStargate SG·1 symbol 12.svgStargate SG·1 symbol 26.svgStargate SG·1 symbol 33.svg",
      "Kallana" => "Stargate SG·1 symbol 06.svgStargate SG·1 symbol 16.svgStargate SG·1 symbol 08.svgStargate SG·1 symbol 03.svgStargate SG·1 symbol 26.svgStargate SG·1 symbol 25.svg",
      "Kheb" => "Stargate SG·1 symbol 26.svgStargate SG·1 symbol 35.svgStargate SG·1 symbol 06.svgStargate SG·1 symbol 08.svgStargate SG·1 symbol 23.svgStargate SG·1 symbol 14.svg",
      "Nassya" => "Stargate SG·1 symbol 18.svgStargate SG·1 symbol 22.svgStargate SG·1 symbol 34.svgStargate SG·1 symbol 16.svgStargate SG·1 symbol 20.svgStargate SG·1 symbol 21.svg",
      "Orban" => "Stargate SG·1 symbol 30.svgStargate SG·1 symbol 02.svgStargate SG·1 symbol 24.svgStargate SG·1 symbol 28.svgStargate SG·1 symbol 08.svgStargate SG·1 symbol 10.svg",
      "Proclarush" => "Stargate SG·1 symbol 29.svgStargate SG·1 symbol 03.svgStargate SG·1 symbol 31.svgStargate SG·1 symbol 34.svgStargate SG·1 symbol 05.svgStargate SG·1 symbol 17.svg",
      "Sahal" => "Stargate SG·1 symbol 29.svgStargate SG·1 symbol 18.svgStargate SG·1 symbol 19.svgStargate SG·1 symbol 20.svgStargate SG·1 symbol 21.svgStargate SG·1 symbol 22.svg",
      "Tartarus" => "Stargate SG·1 symbol 33.svgStargate SG·1 symbol 28.svgStargate SG·1 symbol 23.svgStargate SG·1 symbol 26.svgStargate SG·1 symbol 16.svgStargate SG·1 symbol 31.svg",
      "Tollan" => "Stargate SG·1 symbol 06.svgStargate SG·1 symbol 33.svgStargate SG·1 symbol 27.svgStargate SG·1 symbol 37.svgStargate SG·1 symbol 11.svgStargate SG·1 symbol 18.svg",
      "Tollana" => "Stargate SG·1 symbol 04.svgStargate SG·1 symbol 29.svgStargate SG·1 symbol 08.svgStargate SG·1 symbol 22.svgStargate SG·1 symbol 18.svgStargate SG·1 symbol 25.svg",
      "Vagonbrei" => "Stargate SG·1 symbol 03.svgStargate SG·1 symbol 17.svgStargate SG·1 symbol 02.svgStargate SG·1 symbol 28.svgStargate SG·1 symbol 19.svgStargate SG·1 symbol 30.svg",
      "Volia" => "Stargate SG·1 symbol 04.svgStargate SG·1 symbol 29.svgStargate SG·1 symbol 08.svgStargate SG·1 symbol 22.svgStargate SG·1 symbol 09.svgStargate SG·1 symbol 03.svg",
      "P2X-338" => "Stargate SG·1 symbol 34.svgStargate SG·1 symbol 29.svgStargate SG·1 symbol 18.svgStargate SG·1 symbol 22.svgStargate SG·1 symbol 25.svgStargate SG·1 symbol 33.svg",
      "P2X-555" => "Stargate SG·1 symbol 28.svgStargate SG·1 symbol 08.svgStargate SG·1 symbol 16.svgStargate SG·1 symbol 33.svgStargate SG·1 symbol 13.svgStargate SG·1 symbol 31.svg",
      "P34-353J" => "Stargate SG·1 symbol 38.svgStargate SG·1 symbol 09.svgStargate SG·1 symbol 28.svgStargate SG·1 symbol 15.svgStargate SG·1 symbol 35.svgStargate SG·1 symbol 03.svg",
      "P3R-272" => "Stargate SG·1 symbol 21.svgStargate SG·1 symbol 22.svgStargate SG·1 symbol 03.svgStargate SG·1 symbol 24.svgStargate SG·1 symbol 31.svgStargate SG·1 symbol 27.svg",
      "P3S-114" => "Stargate SG·1 symbol 04.svgStargate SG·1 symbol 16.svgStargate SG·1 symbol 07.svgStargate SG·1 symbol 39.svgStargate SG·1 symbol 09.svgStargate SG·1 symbol 36.svg",
      "P3W-451" => "Stargate SG·1 symbol 19.svgStargate SG·1 symbol 08.svgStargate SG·1 symbol 04.svgStargate SG·1 symbol 37.svgStargate SG·1 symbol 26.svgStargate SG·1 symbol 16.svg",
      "P3X-118" => "Stargate SG·1 symbol 09.svgStargate SG·1 symbol 26.svgStargate SG·1 symbol 34.svgStargate SG·1 symbol 37.svgStargate SG·1 symbol 17.svgStargate SG·1 symbol 21.svg",
      "P3X-562" => "Stargate SG·1 symbol 03.svgStargate SG·1 symbol 28.svgStargate SG·1 symbol 09.svgStargate SG·1 symbol 35.svgStargate SG·1 symbol 24.svgStargate SG·1 symbol 15.svg",
      "P3X-774" => "Stargate SG·1 symbol 32.svgStargate SG·1 symbol 18.svgStargate SG·1 symbol 12.svgStargate SG·1 symbol 23.svgStargate SG·1 symbol 07.svgStargate SG·1 symbol 27.svg",
      "P3X-866" => "Stargate SG·1 symbol 04.svgStargate SG·1 symbol 29.svgStargate SG·1 symbol 10.svgStargate SG·1 symbol 17.svgStargate SG·1 symbol 36.svgStargate SG·1 symbol 25.svg",
      "P3X-984" => "Stargate SG·1 symbol 29.svgStargate SG·1 symbol 05.svgStargate SG·1 symbol 36.svgStargate SG·1 symbol 06.svgStargate SG·1 symbol 23.svgStargate SG·1 symbol 20.svg",
      "P4X-639" => "Stargate SG·1 symbol 12.svgStargate SG·1 symbol 36.svgStargate SG·1 symbol 23.svgStargate SG·1 symbol 18.svgStargate SG·1 symbol 07.svgStargate SG·1 symbol 27.svg",
      "P4X-884" => "Stargate SG·1 symbol 33.svgStargate SG·1 symbol 37.svgStargate SG·1 symbol 39.svgStargate SG·1 symbol 27.svgStargate SG·1 symbol 10.svgStargate SG·1 symbol 07.svg",
      "P5S-117" => "Stargate SG·1 symbol 35.svgStargate SG·1 symbol 28.svgStargate SG·1 symbol 23.svgStargate SG·1 symbol 26.svgStargate SG·1 symbol 25.svgStargate SG·1 symbol 27.svg",
      "P9C-372" => "Stargate SG·1 symbol 25.svgStargate SG·1 symbol 08.svgStargate SG·1 symbol 18.svgStargate SG·1 symbol 29.svgStargate SG·1 symbol 04.svgStargate SG·1 symbol 22.svg",
      "PB5-926" => "Stargate SG·1 symbol 12.svgStargate SG·1 symbol 36.svgStargate SG·1 symbol 23.svgStargate SG·1 symbol 28.svgStargate SG·1 symbol 07.svgStargate SG·1 symbol 27.svg"
   ];

   foreach( $todo as $planet => $address ) {
      $address = str_replace( array( "Stargate SG·1 symbol ", ".svg" ), array( "", "," ), $address );
      $address = trim( $address );
      $address = rtrim( $address, "," );
      $add = explode( ",", $address );
      $tmp = [];
      foreach( $add as $a ) {
         $tmp[] = intval( $a );
      }
      $address = implode( " , ", $tmp );
      echo "\"{$planet}\" => [ " . $address . " ],<br>";
   }*/

   session_start();

   $addresses = [
      "Test" => [ 1, 2, 3, 4, 5, 6, 7 ],
      "Abydos" => [ 27, 29, 15, 32, 12, 30, 1 ],
      "Argos" => [ 24 , 4 , 20 , 9 , 15 , 29, 1 ],
      "Bedrosia" => [ 20 , 4 , 23 , 29 , 25 , 37, 1 ],
      "Camelot" => [ 20 , 2 , 35 , 8 , 26 , 15, 1 ],
      "Cartago" => [ 29 , 8 , 18 , 22 , 4 , 25, 1 ],
      "Castania" => [ 29 , 3 , 6 , 9 , 10 , 16, 1 ],
      "Chulak" => [ 9 , 2 , 23 , 15 , 37 , 20, 1 ],
      "Cimmeria" => [ 11 , 35 , 22 , 17 , 6 , 26, 1 ],
      "Edora" => [ 28 , 24 , 35 , 9 , 15 , 3, 1 ],
      "Euronda" => [ 30 , 27 , 9 , 7 , 18 , 16, 1 ],
      "Hanka" => [ 30 , 6 , 24 , 12 , 14 , 19, 1 ],
      "Heliopolis" => [ 27 , 7 , 15 , 32 , 13 , 30, 1 ],
      "Juna" => [ 29 , 8 , 18 , 22 , 4 , 25, 1 ],
      "KTau" => [ 18 , 2 , 30 , 12 , 26 , 33, 1 ],
      "Kallana" => [ 6 , 16 , 8 , 3 , 26 , 25, 1 ],
      "Kheb" => [ 26 , 35 , 6 , 8 , 23 , 14, 1 ],
      "Nassya" => [ 18 , 22 , 34 , 16 , 20 , 21, 1 ],
      "Orban" => [ 30 , 2 , 24 , 28 , 8 , 10, 1 ],
      "Proclarush" => [ 29 , 3 , 31 , 34 , 5 , 17, 1 ],
      "Sahal" => [ 29 , 18 , 19 , 20 , 21 , 22, 1 ],
      "Tartarus" => [ 33 , 28 , 23 , 26 , 16 , 31, 1 ],
      "Tollan" => [ 6 , 33 , 27 , 37 , 11 , 18, 1 ],
      "Tollana" => [ 4 , 29 , 8 , 22 , 18 , 25, 1 ],
      "Vagonbrei" => [ 3 , 17 , 2 , 28 , 19 , 30, 1 ],
      "Volia" => [ 4 , 29 , 8 , 22 , 9 , 3, 1 ],
      "P2X-338" => [ 34 , 29 , 18 , 22 , 25 , 33, 1 ],
      "P2X-555" => [ 28 , 8 , 16 , 33 , 13 , 31, 1 ],
      "P34-353J" => [ 38 , 9 , 28 , 15 , 35 , 3, 1 ],
      "P3R-272" => [ 21 , 22 , 3 , 24 , 31 , 27, 1 ],
      "P3S-114" => [ 4 , 16 , 7 , 39 , 9 , 36, 1 ],
      "P3W-451" => [ 19 , 8 , 4 , 37 , 26 , 16, 1 ],
      "P3X-118" => [ 9 , 26 , 34 , 37 , 17 , 21, 1 ],
      "P3X-562" => [ 3 , 28 , 9 , 35 , 24 , 15, 1 ],
      "P3X-774" => [ 32 , 18 , 12 , 23 , 7 , 27, 1 ],
      "P3X-866" => [ 4 , 29 , 10 , 17 , 36 , 25, 1 ],
      "P3X-984" => [ 29 , 5 , 36 , 6 , 23 , 20, 1 ],
      "P4X-639" => [ 12 , 36 , 23 , 18 , 7 , 27, 1 ],
      "P4X-884" => [ 33 , 37 , 39 , 27 , 10 , 7, 1 ],
      "P5S-117" => [ 35 , 28 , 23 , 26 , 25 , 27, 1 ],
      "P9C-372" => [ 25 , 8 , 18 , 29 , 4 , 22, 1 ],
      "PB5-926" => [ 12 , 36 , 23 , 28 , 7 , 27, 1 ]
   ];

   $pins = [ 29,28,27,26,31,11,10,6,5,4,25,24,23,22,21 ];
   $namedPins = [
      1 => 29,
      2 => 28,
      3 => 27,
      4 => 26,
      5 => 31,
      6 => 11,
      7 => 10,
      8 => 6,
      9 => 5,
      10 => 4,
      11 => 25,
      12 => 24,
      13 => 23,
      14 => 22,
      15 => 21
   ];
   $circle = [8,7,9,5,10,3,11,1,12,2,13,4,14,6,15];

   $activeAddress = $addresses[ trim( file_get_contents( "activeWorld.txt" ) ) ];

   if( isset( $_GET["dialed"] ) ) {

      $_SESSION["alreadyLitUp"] = [];
      $exec = [];
      foreach( $pins as $pin ) {
         $exec[] = "gpio mode {$pin} out";
         $exec[] = "gpio write {$pin} 0";
      }
      exec( implode( $exec, " && " ) );

      $dialed = json_decode( $_GET["dialed"] );

      $success = true;
      $failedAt = 7;
      $dialingTest = [ false, false, false, false, false, false, false ];
      for( $i = 0; $i < count( $dialed ); $i++ ) {
         if( $activeAddress[$i] != intval( $dialed[$i] ) ) {
            $success = false;
            $failedAt = $i;
            break;
         } else {
            $dialingTest[$i] = true;
         }
      }

      $_SESSION["$dialingTest"] = $dialingTest;

      echo json_encode( [ "response" => [ "dialing" => trim( file_get_contents( "activeWorld.txt" ) ), "whereIsSuccess" => $failedAt, "dialed" => $success, "dialingTest" => $dialingTest ] ] );
   } elseif( isset( $_GET["dialingNow"] )) {

      for( $i = 0; $i <= 1; $i++ ) {
         $prev = null;
         foreach( $circle as $lighThis ) {
            $lightUpChevronPin = $namedPins[$lighThis];
            $exec = [];
            if( !in_array( $lighThis, $_SESSION["alreadyLitUp"] ) )  $exec[] = "gpio write {$lightUpChevronPin} 1";
            if( $prev !== null ) {
               if( !in_array( $prev, $_SESSION["alreadyLitUp"] ) ) $exec[] = "gpio write {$namedPins[$prev]} 0";
            }
            exec( implode( $exec, " && " ) );
            $prev = $lighThis;
            usleep( 155000 );
         }
         $exec = "gpio write {$namedPins[$prev]} 0";
         exec( $exec );
      }

   } elseif( isset( $_GET["dialedNow"] )) {

      $dialed = intval( $_GET["dialedNow"] );
      $lightUpChevron = ( 7 - $dialed );
      $lightUpChevronPin = $namedPins[( isset( $_GET["test"] ) ? 1 : $lightUpChevron)];

      $state = 0;
      for( $i = 0; $i <= 39; $i++ ) {
         $state = abs( $state - 1 );
         $exec = "gpio write {$lightUpChevronPin} {$state}";
         usleep( 2500 + ( $i * 800 ) );
         exec( $exec );
      }

      $exec = "gpio write {$lightUpChevronPin} 1";
      exec( $exec );
      $_SESSION["alreadyLitUp"][] = $lightUpChevron;


   } elseif( isset( $_GET["dialedNowWithError"] )) {

      $dialed = intval( $_GET["dialedNowWithError"] );
      $lightUpChevron = ( 7 - $dialed );
      $lightUpChevronPin = $namedPins[( isset( $_GET["test"] ) ? 1 : $lightUpChevron)];

      $state = 0;

      for( $i = 0; $i <= 79; $i++ ) {
         $state = abs( $state - 1 );
         $exec = "gpio write {$lightUpChevronPin} {$state}";
         usleep( 65000 );
         exec( $exec );
      }
      $exec = "gpio write {$lightUpChevronPin} 0";
      exec( $exec );

   } elseif( isset( $_GET["success"] )) {

      $exec = [];
      foreach( $circle as $lighThis ) {
         $lightUpChevronPin = $namedPins[$lighThis];
         $exec[] = "gpio write {$lightUpChevronPin} 1";
      }
      exec( implode( $exec, " && " ) );

   } elseif( isset( $_GET["reset"] )) {

      $type = $_GET["reset"];
      $_SESSION["alreadyLitUp"] = [];

      if( $type == "hard" ) {
         $exec = [];
         foreach( $pins as $pin ) {
            $exec[] = "gpio mode {$pin} out";
            $exec[] = "gpio write {$pin} 0";
         }
         exec( implode( $exec, " && " ) );
      } else {

         $reverse_circle = array_reverse( $circle );
         foreach( $reverse_circle as $turnThisOff ) {
            $turnThisOffPin = $namedPins[$turnThisOff];
            $exec = "gpio write {$turnThisOffPin} 0";
            exec( $exec );
            usleep( ( $type == "soft" ? 150000 : 75000 ) );
         }

      }


   } else {

      if( isset( $_GET["set"] ) ) {
         file_put_contents( "activeWorld.txt", $_GET["set"] );
         $activeAddress = $addresses[ $_GET["set"] ];
      }

      ?>
      <!DOCTYPE html>
      <html lang="cs">
      <head>
         <meta charset="UTF-8">
         <title>Stargate command</title>
         <link rel="stylesheet" href="css/main.css">
         <style>
            body {
               color: black;
               background: white;
               font-size: 18px;
               font-weight: normal;
               padding: 18px;
            }

            * {
               cursor: auto;
               user-select: auto;
               font-size: 23px;
            }

            td {
               padding: 4px;
            }

            .glyphs {
               font-family: 'Stargate SG-1 Address Glyphs';
               font-size: 30px;
            }

            .glyphs.bigger {
               font-weight: normal;
               font-size: 60px;
            }

            a {
               cursor: pointer;
               color: blue;
            }
         </style>
      </head>
      <body>
      <a href="/">&lt;&lt; ZPĚT</a><br>
      <a href="/visualizer.php">&lt;&lt; Vizualizér</a><br><br>
      <h1>Aktivní planeta:<br><?php echo trim( file_get_contents( "activeWorld.txt" ) ); ?></h1><br>
      <h1>Adresa planety:<br><span class="glyphs bigger"><?php echo getASCII( $activeAddress ); ?></span></h1><br>
      <h1>Číselná adresa planety:<br><?php echo getNumber( $activeAddress ); ?></h1>
      <br><br>
      <h1>Seznam adres</h1>
      <table>
         <?php
            foreach( $addresses as $planet => $address ) {
               $number = getNumber( $address );
               $ascii = getASCII( $address );
               echo "<tr><td><strong><a href='server.php?set={$planet}'>{$planet}</a></strong></td><td><span class='glyphs'>{$ascii}</span></td><td>&nbsp;&nbsp;&nbsp;({$number})</td></tr>";
            }
         ?>
      </table>
      </body>
      </html>
      <?php
   }

   function getASCII( $address ) {
      $ascii = [];
      foreach( $address as $char ) {
         $ascii[] = chr( 64 + ( $char > 26 ? $char + 6 : $char ) );
      }
      $ascii = implode( " ", $ascii );
      return $ascii;
   }

   function getNumber( $address ) {
      $number = implode( ", ", $address );
      return $number;
   }
